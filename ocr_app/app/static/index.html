<!DOCTYPE html>
<html>
<head>
  <title>OCR Extractor</title>
  <style>
    #inputImageContainer {
      text-align: center;
      margin-bottom: 20px;
    }
    #inputImageContainer img {
      max-width: 90vw;
      max-height: 400px;
      border: 1px solid #ccc;
    }
    #modelButtons {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #modelButtons .buttons {
      display: flex;
      gap: 10px;
    }
    #modelButtons button {
      padding: 5px 10px;
      cursor: pointer;
    }
    #modelButtons button.selected {
      font-weight: bold;
      background-color: #ddd;
    }
    #resetBtn {
      background-color: #f44336;
      border: none;
      color: white;
      padding: 5px 12px;
      border-radius: 3px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
    }
    #preprocessToggle {
      margin-left: 20px;
      display: flex;
      align-items: center;
      font-weight: normal;
      cursor: pointer;
      user-select: none;
    }
    #preprocessToggle input {
      margin-right: 6px;
    }
    #croppedRegionsContainer {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    #stepsContainer, #warningsContainer {
      flex: 1;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 600px;
      overflow-y: auto;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .croppedImage {
      max-width: 100%;
      max-height: 200px;
      margin-bottom: 10px;
      object-fit: contain;
      border: 1px solid #666;
      border-radius: 4px;
    }
    .extractedTextBlock {
      white-space: pre-wrap;
      font-family: monospace;
      background-color: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
    }
    #processingTimeDisplay {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Upload Image for OCR</h2>

  <div id="modelButtons">
    <div class="buttons">
      <button id="btn-yolo" class="selected" onclick="selectModel('yolo')">YOLO</button>
      <button id="btn-rtdetr" onclick="selectModel('rtdetr')">RTDETR</button>
    </div>
    <button id="resetBtn" onclick="resetUI()">Reset</button>
    <label id="preprocessToggle" title="Toggle preprocessing on/off">
      <input type="checkbox" id="usePreprocessing" checked />
      Use Preprocessing
    </label>
  </div>

  <br>

  <input type="file" id="imageInput" accept="image/*"><br><br>

  <button onclick="uploadImage()">Extract Text</button>

  <button onclick="startRecording()" id="startRecordingBtn">Start Recording</button>
  <button onclick="stopRecording()" id="stopRecordingBtn" disabled>Stop Recording</button>

  <div id="inputImageContainer">
    <h3>Input Image</h3>
    <img id="preview" alt="Input Image" />
  </div>

  <div id="croppedRegionsContainer">
    <div id="stepsContainer">
      <h3>Detected Steps</h3>
      <div id="stepsImages"></div>
      <h4>Extracted Text for Steps</h4>
      <div id="stepsText"></div>
    </div>
    <div id="warningsContainer">
      <h3>Detected Warnings</h3>
      <div id="warningsImages"></div>
      <h4>Extracted Text for Warnings</h4>
      <div id="warningsText"></div>
    </div>
  </div>

  <div id="processingTimeDisplay">Processing time will appear here.</div>

  <script>
    let selectedModel = "yolo";

    function selectModel(modelName) {
      selectedModel = modelName;
      document.getElementById("btn-yolo").classList.toggle("selected", modelName === "yolo");
      document.getElementById("btn-rtdetr").classList.toggle("selected", modelName === "rtdetr");
      clearResults();
    }

    function clearResults() {
      document.getElementById('stepsImages').innerHTML = '';
      document.getElementById('warningsImages').innerHTML = '';
      document.getElementById('stepsText').innerHTML = '';
      document.getElementById('warningsText').innerHTML = '';
      document.getElementById('imageInput').value = '';
    }

    function resetUI() {
      selectModel('yolo');
      clearResults();
      document.getElementById('usePreprocessing').checked = true;
      document.getElementById('preview').src = '';
      document.getElementById('processingTimeDisplay').innerText = 'Processing time will appear here.';
    }

    async function processResultsIncrementally(results) {
      const stepsImagesDiv = document.getElementById('stepsImages');
      const stepsTextDiv = document.getElementById('stepsText');
      const warningsImagesDiv = document.getElementById('warningsImages');
      const warningsTextDiv = document.getElementById('warningsText');

      let stepsFound = false;
      let warningsFound = false;

      for (const region of results) {
        const cls = region.class.toLowerCase();

        const img = document.createElement('img');
        img.src = region.processed_image_b64;
        img.alt = `${cls} crop`;
        img.className = 'croppedImage';

        const textDiv = document.createElement('div');
        textDiv.className = 'extractedTextBlock';
        textDiv.textContent = 'Processing OCR...';

        if (cls === 'steps') {
          stepsFound = true;
          stepsImagesDiv.appendChild(img);
          stepsTextDiv.appendChild(textDiv);
        } else if (cls === 'warning' || cls === 'warnings' || cls === 'warningss') {
          warningsFound = true;
          warningsImagesDiv.appendChild(img);
          warningsTextDiv.appendChild(textDiv);
        }

        await new Promise(r => setTimeout(r, 50));

        textDiv.textContent = region.extracted_text || "[No text extracted]";
      }

      if (!stepsFound) {
        stepsTextDiv.innerHTML = '<p>No steps detected.</p>';
      }
      if (!warningsFound) {
        warningsTextDiv.innerHTML = '<p>No warnings detected.</p>';
      }
    }

    function uploadImage() {
      const fileInput = document.getElementById("imageInput");
      const preview = document.getElementById("preview");

      if (!fileInput.files.length) {
        alert("Please select an image first.");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
      };
      reader.readAsDataURL(file);

      const usePreprocessingCheckbox = document.getElementById("usePreprocessing");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("roi_model_name", selectedModel);
      formData.append("use_preprocessing", usePreprocessingCheckbox.checked ? "true" : "false");

      document.getElementById('stepsImages').innerHTML = '';
      document.getElementById('warningsImages').innerHTML = '';
      document.getElementById('stepsText').innerHTML = '<p>Loading steps...</p>';
      document.getElementById('warningsText').innerHTML = '<p>Loading warnings...</p>';

      fetch("http://localhost:8000/detect-and-ocr", {
        method: "POST",
        body: formData,
      })
      .then(response => response.json())
      .then(async (data) => {
        clearResults();
        if (data.ocr_results && data.ocr_results.length > 0) {
          await processResultsIncrementally(data.ocr_results);
          document.getElementById("processingTimeDisplay").innerText =
            `Last Image Processing Time: ${data.processing_time_sec} seconds`;
        } else {
          document.getElementById('stepsText').innerHTML = '<p>No steps detected.</p>';
          document.getElementById('warningsText').innerHTML = '<p>No warnings detected.</p>';
          document.getElementById("processingTimeDisplay").innerText = "Processing time: N/A";
          alert("No text extracted or no regions detected.");
        }
      })
      .catch(err => {
        clearResults();
        alert("Error: " + err);
      });
    }

    let stream = null;
    let videoElem = null;
    let recordInterval = null;

    async function startRecording() {
      try {
        stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        videoElem = document.createElement('video');
        videoElem.srcObject = stream;
        await videoElem.play();

        recordInterval = setInterval(captureAndUploadScreenshot, 10000);
        captureAndUploadScreenshot();

        document.getElementById('startRecordingBtn').disabled = true;
        document.getElementById('stopRecordingBtn').disabled = false;
      } catch (e) {
        alert('Screen capture failed: ' + e);
      }
    }

    function stopRecording() {
      if (recordInterval) clearInterval(recordInterval);
      if (stream) stream.getTracks().forEach(track => track.stop());
      stream = null;
      videoElem = null;

      document.getElementById('startRecordingBtn').disabled = false;
      document.getElementById('stopRecordingBtn').disabled = true;
    }

    function captureAndUploadScreenshot() {
      if (!videoElem) return;
      const canvas = document.createElement('canvas');
      canvas.width = videoElem.videoWidth;
      canvas.height = videoElem.videoHeight;
      canvas.getContext('2d').drawImage(videoElem, 0, 0);
      canvas.toBlob(blob => {
        const formData = new FormData();
        formData.append("file", blob, 'screenshot.png');
        formData.append("roi_model_name", selectedModel);
        formData.append("use_preprocessing", document.getElementById('usePreprocessing').checked ? "true" : "false");
        fetch("http://localhost:8000/detect-and-ocr", {
          method: "POST",
          body: formData,
        })
        .then(response => response.json())
        .then(async (data) => {
          clearResults();
          if (data.ocr_results && data.ocr_results.length > 0) {
            await processResultsIncrementally(data.ocr_results);
            document.getElementById("processingTimeDisplay").innerText =
              `Last Image Processing Time: ${data.processing_time_sec} seconds`;
          } else {
            document.getElementById('stepsText').innerHTML = '<p>No steps detected.</p>';
            document.getElementById('warningsText').innerHTML = '<p>No warnings detected.</p>';
            document.getElementById("processingTimeDisplay").innerText = "Processing time: N/A";
          }
        })
        .catch(err => {
          clearResults();
          alert("Error during OCR: " + err);
        });
      }, 'image/png');
    }
  </script>
</body>
</html>
